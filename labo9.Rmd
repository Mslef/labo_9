---
title: "Laboratoire 9"
output: "html_document"
---
# Question 1

## 1.a

Le modèle global de paysage, de mère caribou et du jeune est un modèle global, puisqu'on peut reconstruire tous les autres modèles à partir des variables qui le composent. Voici une représentation de comment les modèles s'imbriquent les uns dans les autres, avec les variables explicatives des modèles les plus imbriqués entre parenthèses :

- Modèle de paysage, de mère caribou et du jeune
  - Modèle de paysage
    - Modèle de quantité et type d'habitat (Feuillus + Résineux + Aquatique)
    - Modèle de perturbations et altitude (Présence de routes + Altitude)
  - Modèle de mère caribou et du jeune
    - Modèle de condition et expérience de la mère (Âge de la mère + Masse de la mère)
    - Modèle de compétition (Nombre de jeunes avec la mère)
    - Modèle de condition du jeune (Masse initiale du jeune)

## 1.b
Nous importons d'abord les données et nous en observons la structure et les relations entre les variables à l'aide d'un graphique.

```{r}
setwd("~/Documents/donnees_eco/Labo9")
caribou <- read.table("caribou.txt", header=TRUE)
str(caribou)
head(caribou)

# Transformation des variables catégorielles
caribou$MotherYoung <- as.factor(caribou$MotherYoung)
caribou$RoadPresence <- as.factor(caribou$RoadPresence)

plot(caribou)
# Matrice de corrélations pour les variables explicatives numériques
cor(caribou[c("InitialMass", "ConifCover", "DecidCover", "WaterCover", "Altitude")])
```

Nous observervons que les variables de couvert de feuillu et de couvert de conifères sont fortement corrélées, avec une corrélation de Pearson de -0.789. Ce coefficient est cohérent avec le fait que si un peuplement est dominé par les résineux, les feuillus sont par définition moins présents et vice-versa.

Cette forte colinéarité pose problème pour les modèles qui utilisent ces deux variables, à savoir le modèle de quantité et type d'habitat, le modèle de paysage et le modèle de paysage, de mère caribou et du jeune. Nous enlevons la variable explicative Feuillus de ces modèles pour les analyses.

Nous avons aussi transformé en facteur les variables MotherYoung, qui était un charactère, et RoadPresence, qui était un entier, afin de les utliser correctement dans les analyses.

## 1.c

Nous comparons les différents modèles à l'aide de l'AIC. Nous utilisons les mêmes formulations des 8 modèles que proposés dans l'énoncé, à la différence que nous avons éliminé la variable Feuillus des modèles décrits au point précédent.

```{r}
model_list = list(
  lm(MassGain ~ ConifCover + WaterCover + Altitude + RoadPresence + MotherAge + MotherMass + MotherYoung + InitialMass, data=caribou),
  lm(MassGain ~ ConifCover + WaterCover + Altitude + RoadPresence, data=caribou),
  lm(MassGain ~ ConifCover + WaterCover, data=caribou),
  lm(MassGain ~ Altitude + RoadPresence, data=caribou),
  lm(MassGain ~ MotherAge + MotherMass + MotherYoung + InitialMass, data=caribou),
  lm(MassGain ~ MotherAge + MotherMass, data=caribou),
  lm(MassGain ~ MotherYoung, data=caribou),
  lm(MassGain ~ InitialMass, data=caribou)
)

names = c("Paysage, de mère caribou et du jeune",
  "Paysage",
  "Quantité et type d'habitat",
  "Perturbations et altitude",
  "Mère caribou et du jeune",
  "Condition et expérience de la mère",
  "Compétition",
  "Condition du jeune"
)

# Calcul d'AICc
AICc <- function(x) {
  -2*logLik(x)[1]+2*(length(coefficients(x))+1)*(60/(60-(length(coefficients(x))+1)-1))
}

aic <- data.frame(
  Model_name = names,
  AIC = unlist(lapply(model_list, AICc))
)

aic[order(aic$AIC), ]

coefs <- lapply(model_list, summary) |>
  sapply(function(x) x$coef)

names(coefs) <- names

coefs[c(1,4,2)]
```

Le modèle général, soit le modèle de paysage, de la mère caribou et du jeune, est le meilleur, avec une AIC de 319.00, mais les deux modèles suivants sont très proches, avec une AIC de 322.26 pour le modèle de perturbation et alitude, et 327.75 pour le modèle de paysage. Les AIC des autres modèles sont proches les unes des autres, soit autour de 374.

Dans les summary des 3 modèles, on voit que la présence de route à la p-value la plus faible. Nous interprétertons de ces résultats que la présence de route jouent un rôle important dans l'habitat du caribou. 

## 1.d

Afin de déterminer l'effet de la proportion de résineux et de la présence de route sur le gain de masse chez les jeunes caribous à l'aide d'une inférence multimodèle, nous procédons d'abord à une sélection de modèles qui utilisent les variables ConfiCover et RoadPresence. Nous arrivons à 3 modèles pour chaque variable.

```{r}

# Fonction pour calculer les poids d'AIC
compute_AICWt <- function(aic_list) {
  modelLik = exp(-0.5 * aic_list - min(aic_list))
  modelLik/sum(modelLik)
}

# Poids pour la variable RoadPresence
road_AICWt <- compute_AICWt(aic["AIC"][c(1,2,4),])

# Estimés, moyenne et SE pour les modèles contenant la variable RoadPresence
road_ests <- c(coef(model_list[[1]])["RoadPresence1"],
  coef(model_list[[2]])["RoadPresence1"],
  coef(model_list[[4]])["RoadPresence1"])
mod_road_avg_est <- sum(road_AICWt * road_ests)
road_se <- c(summary(model_list[[1]])$coef["RoadPresence1", 2],
  summary(model_list[[2]])$coef["RoadPresence1", 2],
  summary(model_list[[4]])$coef["RoadPresence1", 2])

# SE inconditionnelle avec l'equation révisée
uncond_se_new_road <- sqrt(sum(road_AICWt*(road_se^2 + (road_ests - mod_road_avg_est)^2)))

# Intervalle de confiance à 95% pour le coefficient de RoadPresence
uncond_95CI_road <- mod_road_avg_est + 1.96 * c(-1*uncond_se_new_road, uncond_se_new_road)

# Poids pour la variable ConifCover
conif_AICWt <- compute_AICWt(aic["AIC"][c(1,2,3),])

# Estimés, moyenne et SE pour les modèles contenant la variable ConifCover
conif_ests <- c(coef(model_list[[1]])["ConifCover"],
  coef(model_list[[2]])["ConifCover"],
  coef(model_list[[3]])["ConifCover"])
mod_conif_avg_est <- sum(conif_AICWt * conif_ests)
conif_se <- c(summary(model_list[[1]])$coef["ConifCover", 2],
  summary(model_list[[2]])$coef["ConifCover", 2],
  summary(model_list[[3]])$coef["ConifCover", 2])

# SE inconditionnelle avec l'equation révisée
uncond_se_new_conif <- sqrt(sum(conif_AICWt*(conif_se^2 + (conif_ests - mod_conif_avg_est)^2)))

# Intervalle de confiance à 95% pour le coefficient de ConifCover
uncond_95CI_conif <- mod_conif_avg_est + 1.96 * c(-1*uncond_se_new_conif, uncond_se_new_conif)
```

On observe que blabla

## 1.e

Avec 

```{r}
library("AICcmodavg")

aictab(model_list)

# Inférence multimodèles pour la route
mod_road <- modavg(model_list, parm = "RoadPresence1")
mod_road

# Graphiques pour la route
rd_labels <- c(mod_road$Mod.avg.table$Modnames, "Moyenne pondérée")
rd_pos <- as.numeric(factor(rd_labels)) 
rd_lower_ci <- c(c(mod_road$Mod.avg.table$Beta_est - 1.96*mod_road$Mod.avg.table$SE), mod_road$Lower.CL)
rd_upper_ci <- c(c(mod_road$Mod.avg.table$Beta_est + 1.96*mod_road$Mod.avg.table$SE), mod_road$Upper.CL)

plot(rd_pos, c(mod_road$Mod.avg.table$Beta_est, mod_road$Mod.avg.beta),
  xaxt = "n", pch = 16,
     xlab = "Modèles", ylab = "Coefficients", main = "Inférence multimodèle pour la variable présence de route", ylim=c(max(rd_upper_ci), min(rd_lower_ci)))
axis(1, at = rd_pos, labels = rd_labels)
arrows(x0 = rd_pos, y0 = rd_lower_ci, 
  x1 = rd_pos, y1 = rd_upper_ci, 
  angle = 90, code = 3, length = 0.1, col = "blue")

cf_pos <- as.numeric(factor(mod_road$Mod.avg.table$Modnames)) 

# Estimation du gain de masse en fonction du coefficient inféré de la route
# preds <- modavgPred(model_list, modnames = names, newdata = caribou)
# str(preds)
# plot(preds$mod.avg.pred)


# Inférence mutlimodèles pour le couvert de conifères
mod_conif <- modavg(model_list, parm = "ConifCover")
mod_conif

cf_labels <- c(mod_conif$Mod.avg.table$Modnames, "Moyenne pondérée")
cf_pos <- as.numeric(factor(cf_labels)) 
cf_lower_ci <- c(c(mod_conif$Mod.avg.table$Beta_est - 1.96*mod_conif$Mod.avg.table$SE), mod_conif$Lower.CL)
cf_upper_ci <- c(c(mod_conif$Mod.avg.table$Beta_est + 1.96*mod_conif$Mod.avg.table$SE), mod_conif$Upper.CL)

plot(cf_pos, c(mod_conif$Mod.avg.table$Beta_est, mod_conif$Mod.avg.beta), xaxt = "n", pch = 16,
     xlab = "Modèles", ylab = "Coefficients (Moyennes et intervalles de confiance)", main = "Inférence multimodèle pour la variable de couvert de conifères", ylim=c(max(cf_upper_ci), min(cf_lower_ci)))
axis(1, at = cf_pos, labels = cf_labels)
arrows(x0 = cf_pos, y0 = cf_lower_ci, 
  x1 = cf_pos, y1 = cf_upper_ci, 
  angle = 90, code = 3, length = 0.1, col = "blue")
```
